<h2>Dépenses du <strong>commun</strong>
  <%= render :partial => 'lignes/info_selection_temporelle' %>
</h2>

<%= will_paginate @depense_communs,
            :renderer => "PaginationLinkRenderer",
            :remote => {:update => "to-update", :method => :get} %>
<%-
  case @type_montant.to_s
	when "htr" then css_class_montants_ht = "selected"
	when "ht" then css_class_montants_ht = "selected"
	when "ttc" then css_class_montants_ttc = "selected"
  end
-%>
<table class="depenses">
  <thead>
    <tr>
      <th style="border:none;" colspan="9"></th>
      <th style="border-color:#ccc;text-align:center;" colspan="8">
				<!-- Pour les depenses du commun, on ne considère pas de montant_htr
				<a href="?type_montant=htr" class="type_montants <%#= css_class_montants_htr %>" >Montants HTR</a> -->
				<a href="?type_montant=ht" class="type_montants <%= css_class_montants_ht %>" >Montants HT</a> -
				<a href="?type_montant=ttc" class="type_montants <%= css_class_montants_ttc %>">Montants TTC</a>
			</th>
    </tr>
    <tr>
      <th class="soldee"></th>
      <th class="verrou"></th>
      <th>
        <a href="?order_by=budgetaire_reference" class="order-by <%= @order_by_direction if @order_by_field == 'budgetaire_reference' %>">Réf.Budg.</a>
      </th>
      <th>
        <a href="?order_by=reference" class="order-by <%= @order_by_direction if @order_by_field == 'reference' %>">Référence</a>
      </th>
      <th>
        <a href="?order_by=date_commande" class="order-by <%= @order_by_direction if @order_by_field == 'date_commande' %>">Date <br/>(mill&eacute;sime)</a>
      </th>
      <th colspan='3'>
        <a href="?order_by=intitule" class="order-by <%= @order_by_direction if @order_by_field == 'intitule' %>">Intitulé</a>
      </th>
      <th>
        <a href="?order_by=fournisseur" class="order-by <%= @order_by_direction if @order_by_field == 'fournisseur' %>">Fournisseur</a>
      </th>
      <th class="money">
        <a href="?order_by=montant_engage" class="order-by <%= @order_by_direction if @order_by_field == 'montant_engage' %>">Engagé</a>
      </th>
      <th class="money">
        <a href="?order_by=montant_factures" class="order-by <%= @order_by_direction if @order_by_field == 'montant_factures' %>">Facturé</a>
      </th>
			<th class="money">
        <a href="?order_by=montant" class="order-by <%= @order_by_direction if @order_by_field == 'montant' %>">Engag&eacute; / Pay&eacute;</a>
      </th>
      <%- if @ligne.contrat.is_budget_editable? current_user -%>
			  <% if @ligne.contrat.come_from_inria? %>
          <th class="actions"></th>
        <% end %>
      <th class="actions"></th>
      <%- end -%>
    </tr>
  </thead>
  <tbody id="depense_list">
  <%- for @depense_commun in @depense_communs -%>
    <%- iterate_compute_subtotals(@depense_commun) if @display_subtotals -%>
    <tr class="depense">
      <%
      soldee_class = 'non_soldee'
      soldee_class = 'soldee' if @depense_commun.commande_solde
      %>
      <td class="<%= soldee_class %>"></td>
      <td class="no-verrou"></td>
      <td><%=@depense_commun.budgetaire_reference.code%></td>
      <td><%= @depense_commun.reference %></td>
			<td><%=french_small_date @depense_commun.date_commande %><br/>
        <% if !@depense_commun.millesime.blank? -%>
          (<%= @depense_commun.millesime.year %>)
        <% end %>
      </td>
      <td colspan='3'>
        <%=  link_to truncate(@depense_commun.intitule,:length => 15, :ommission => '...'),
                     ligne_depense_commun_path(@ligne, @depense_commun),
                     :title => @depense_commun.intitule %>
      </td>
      <td>
        <span title="<%= @depense_commun.fournisseur %>"><%= truncate( @depense_commun.fournisseur,:length => 15, :ommission => '...') %></span>
      </td>
      <td class="money" >
        <%= "<strong>".html_safe() if @depense_commun.commande_solde? -%>
          <%= my_number_to_currency @depense_commun.montant_engage %>
        <%= "</strong>".html_safe() if @depense_commun.commande_solde? -%>
      </td>
      <td class="money">
	      <%= my_number_to_currency @depense_commun.montant_factures(@type_montant, @current_date_start, @current_date_end) %>
      </td>
			<td class="money">
        <%= my_number_to_currency @depense_commun.montant(@current_date_start, @current_date_end, "sommes_engagees", @type_montant) %>
      </td>
      <%- if @ligne.contrat.is_budget_editable? current_user -%>
			  <%# if @ligne.contrat.come_from_inria? %>
          <% if @depense_commun.verif %>
            <td class="actions_depenses" id=<%= "depense_toggle_verif_id_"+@depense_commun.id.to_s %>><a href="" onClick="toggle_verif_depense('commun','<%=@depense_commun.id%>',0);return false;" title="Cette d&eacute;pense est v&eacute;rifi&eacute;e ! (Cliquez-moi pour annuler)"><%= image_tag "verif.jpg" %></a> </td>
          <% else %>
            <td class="actions_depenses" id=<%= "depense_toggle_verif_id_"+@depense_commun.id.to_s %>><a href="" onClick="toggle_verif_depense('commun','<%=@depense_commun.id%>',1);return false;" title="Cette d&eacute;pense n'est pas v&eacute;rifi&eacute;e. (Cliquez-moi pour valider la v&eacute;rification)"><%= image_tag "question_mark.png" %></a> </td>
          <% end %>
        <%# end %>
        <td class="actions_depenses">
          <%= link_to 'Editer', edit_ligne_depense_commun_path(@ligne, @depense_commun) %>
        </td>
      <%- end -%>
    </tr>
    <%- if @afficher_factures == 'true' && @depense_commun.depense_commun_factures.count > 0 -%>
      <%= render :partial => 'list_show_factures', :object => @depense_commun %>
    <%- end -%>
  <% end %>
  <%= render :partial => 'depenses/list_totals' %>
  </tbody>
</table>

<input type="hidden" value="1" id="page" name="page" />
